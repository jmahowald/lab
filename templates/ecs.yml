Name: ecs

Modules:
- Name: registry
  local_path: git@github.com:jmahowald/terraform-ecs-modules//registry
  vars:
  - var_name: registry_address
  - var_name: registry_account
  - var_name: registry_password
- Name: ecs
  outputs: 
  - cluster_id
  - ecs_role_arn
  - vpc_id
  - public_listener_arn
  - asg_name
  - cloudwatch_log_group_prefix
  module_vars:
  - module_name: registry
    mappings:
    - var_name: ecs_extra_config
      source_var_name: ecs_auth_data
  remote_source_vars:
  - source_name: ecs_infra
    config:
      bucket: {{.Env.REMOTE_STATE_BUCKET}}
      key: {{.Env.ECS_INFRA_KEY}}
      region: {{.Env.REMOTE_STATE_BUCKET_REGION}}
    mappings:
    - var_name: ecs_role_arn
  - source_name: vpc_layer
    config:
      bucket: {{.Env.REMOTE_STATE_BUCKET}}
      key: {{.Env.VPC_KEY}}
      region: {{.Env.REMOTE_STATE_BUCKET_REGION}}
    mappings:
    - source_var_name: public_subnet_ids
      var_name: elb_subnet_ids
    - source_var_name: private_subnet_ids
      var_name: asg_subnet_ids
    - source_var_name: private_sg_id  
      var_name: instance_security_group_id
    - var_name: private_subnet_ids
    - var_name: public_subnet_ids
    - var_name: public_security_group_id  
      source_var_name: public_sg_id
    - var_name: private_security_group_id  
      source_var_name: private_sg_id


    # - var_name: public_security_group_id  
    #   source_var_name: public_sg_id
  local_path: git@github.com:backpackhealth/terraform-ecs-modules//cluster
  vars:
  - var_name: key_name
  - var_name: environment_name
    default: {{.Env.ENV_LEVEL}}-{{.Env.ENV_COLOR}}
  - var_name: autoscaling_group_name
    default: {{.Env.ENV_LEVEL}}-{{.Env.ENV_COLOR}}-ecs
  - var_name: asg_min
    default: 0
  - var_name: asg_max
    default: 3
  - var_name: asg_desired
    default: 1
  - var_name: instance_type
    default: t2.medium
  - var_name: ecs_extra_config
    default: ECS_ENGINE_TASK_CLEANUP_WAIT_DURATION=2m
  - var_name: zone_name
    default: {{.Env.ZONE_NAME}}
  - var_name: environment
    default: {{.Env.ENV_NAME}}
